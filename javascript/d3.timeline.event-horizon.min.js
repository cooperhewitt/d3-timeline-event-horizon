function timeline(a,c){var e=d3.min(c,function(k){return k.start}),b=d3.max(c,function(k){return k.end}),f=e-20,d=b+20;this.ctx=c;var h=[],g=[];for(var j in this.ctx){var i=this.ctx[j].start;i&&$.inArray(i,h)==-1&&h.push(i)}for(j in this.ctx)(i=this.ctx[j].end)&&$.inArray(i,g)==-1&&$.inArray(i,h)==-1&&g.push(i);this.beginnings=h;this.endings=g;this.ctx.unshift({name:"before and after",start:f,end:d});this.container=a;this.min=e;this.max=b;this.padding=20;this.before=f;this.after=d;this.h_years=this.h_labels=
this.w=this.h=this.scale=this.svg=null;this.h_events=40;this.evt=null}
timeline.prototype.setup=function(){var a="#"+this.container,c=$(a).innerWidth(),e=$(a).innerHeight();this.h=e;this.w=c;a="#"+this.container;a=d3.select(a).append("svg");a.attr("width",c);a.attr("height",e);c=d3.scale.linear().domain([this.before,this.after]).range([0,c]);this.svg=a;this.scale=c;a=e=c=0;if(this.evt){if(this.evt.start_prefix){var b=this.measure_text(this.evt.start_prefix+" ");a=Math.max(a,b.width)}if(this.evt.end_prefix){b=this.measure_text(this.evt.end_prefix+" ");a=Math.max(a,b.width)}if(this.evt.echo_prefix){b=
this.measure_text(this.evt.echo_prefix+" ");a=Math.max(a,b.width)}}for(var f in this.ctx){b=this.measure_text(this.ctx[f].name);c=Math.max(b.width,c);b=this.measure_text(this.ctx[f].start);e=Math.max(b.width+a,e)}this.h_labels=Math.ceil(c);this.h_years=Math.ceil(e);this.h=this.h_labels+this.h_events+this.h_years;this.svg.attr("height",this.h)};timeline.prototype.redraw=function(){d3.select("#timeline").select("svg").remove();this.draw(this.evt)};
timeline.prototype.draw=function(a){if(a)this.evt=a;this.setup();this.draw_event_blocks();this.draw_beginnings();this.draw_endings();this.draw_ctx();this.draw_evt()};
timeline.prototype.draw_event_blocks=function(){var a=this.scale,c=this.max,e=this.h,b=this.h_events,f=this.h_years;this.svg.selectAll("rect-fill").data(this.ctx).enter().append("rect").attr("x",function(d){return a(d.start)}).attr("y",function(){return e-(f+b)}).attr("width",function(d){if(d.end==0)d.end=c;return a(d.end)-a(d.start)}).attr("height",function(){return b}).attr("class",function(d){var h=["timeline-block"];d.name=="before and after"&&h.push("timeline-before-after");return h.join(" ")}).attr("id",
function(d){return"event-"+d.start+"-"+d.end})};
timeline.prototype.draw_beginnings=function(){var a=this,c=this.scale,e=this.h;this.svg.selectAll("text-beginnings").data(this.beginnings).enter().append("text").text(function(b){if(!a.evt)return b;var f=a.evt.start,d=a.evt.end,h=a.evt.echo,g=f<b?c(b)-c(f):c(f)-c(b);if((g=!f||g>=18?1:0)&&d){g=f<b?c(b)-c(d):c(d)-c(b);g=g<=-18||g>=18?1:0}if(g&&h){g=f<b?c(b)-c(h):c(h)-c(b);g=g<=-18||g>=18?1:0}return g?b:""}).attr("x",function(b){return b=c(b)-12}).attr("y",function(b){b=a.measure_text(b);return e-Math.floor(a.h_years-
b.width)}).attr("transform",function(b){if(b.name!="before and after"){var f=a.measure_text(b);f=Math.floor(a.h_years-f.width);return"rotate("+[-90,c(b),e-f-13].join(",")+")"}}).style("text-anchor","center").attr("id",function(b){return"date-"+b}).attr("class",function(){return"timeline-event timeline-event-year"})};
timeline.prototype.draw_endings=function(){var a=this,c=this.scale,e=this.h;this.svg.selectAll("text-endings").data(this.endings).enter().append("text").text(function(b){if(!a.evt)return b;var f=a.evt.end;if(!f)return b;f=f<b?c(b)-c(f):c(f)-c(b);if((f=f>=18?1:0)&&a.evt.echo){f=a.evt.echo<b?a.scale(b)-a.scale(a.evt.echo):a.scale(a.evt.echo)-a.scale(b);f=f<=-18||f>=18?1:0}return f?b:""}).attr("x",function(b){return b=c(b)-12}).attr("y",function(b){b=a.measure_text(b);return e-Math.floor(a.h_years-b.width)}).attr("transform",
function(b){if(b.name!="before and after"){var f=a.measure_text(b);f=Math.floor(a.h_years-f.width);return"rotate("+[-90,c(b),e-f-13].join(",")+")"}}).style("text-anchor","center").attr("id",function(b){return"date-"+b}).attr("class","timeline-event timeline-event-year-ending")};
timeline.prototype.draw_ctx=function(){var a=this,c=this.scale,e=this.h,b=this.h_years,f=this.h_events;this.svg.selectAll("text-ctx").data(this.ctx).enter().append("text").text(function(d){if(d.name!="before and after")return d.name}).attr("x",function(d){return a.scale(d.start)}).attr("y",function(){return e-(b+f)}).on("mouseover",function(d){if(d.name!="before and after"){var h=d.start,g=d.end,j=d3.select("#date-"+h),i=j.attr("class");j.attr("class",i+" timeline-event-year-hover");j=d3.select("#date-"+
g);i=j.attr("class");j.attr("class",i+" timeline-event-year-hover");a.draw_event_span(h,g);if(a.evt){h=a.evt.start;g=a.evt.end;i=a.evt.echo;if(a.draw_evt_span()&&a.does_overlap(h,g,d.start,d.end))a.draw_span_block(d.start>h?d.start:h,d.end<g?d.end:g,"hover-block");else h&&a.is_between(d.start,d.end,h,6)&&a.draw_arrow(h,"hover-arrow-start-"+h,"youarehere");i>a.min&&i<a.max&&a.is_between(d.start,d.end,i,6)&&a.draw_arrow(i,"hover-arrow-echo-"+i,"echo")}}}).on("mouseout",function(d){if(d.name!="before and after"){var h=
d.start;d=d.end;$("#span-"+h+"-"+d+"-rect").remove();var g=d3.select("#date-"+h);h=g.attr("class").replace("timeline-event-year-hover","");g.attr("class",h);d=d3.select("#date-"+d);h=d.attr("class").replace("timeline-event-year-hover","");d.attr("class",h);if(a.evt){h=a.evt.start;d=a.evt.echo;a.remove_arrow("hover-arrow-start-"+h);a.remove_arrow("hover-arrow-echo-"+d);$("#hover-block").remove()}}}).on("click",function(d){d.link&&window.open(d.link,"_timeline")}).style("text-anchor","center").attr("transform",
function(d){if(d.name!="before and after")return"rotate("+[-90,c(d.start),e-(b+f+10)].join(",")+")"}).attr("class","timeline-event timeline-event-item")};
timeline.prototype.draw_evt=function(){if(this.evt){var a=this.evt.start,c=this.evt.end,e=a,b=c;if(e<this.min)e=this.min-this.padding/2;if(c==0)b=(new Date).getYear()+1900;else if(b>this.max)b=this.max+this.padding/2;var f=this.scale(e),d=this.scale(e)-this.scale(b);d=d<=-18||d>=18?1:0;var h=null;if(this.evt.echo){h=e<this.evt.echo?this.scale(e)-this.scale(this.evt.echo):this.scale(this.evt.echo)-this.scale(e);h=h<=-18||h>=18?1:0}if(a){var g=a;if(this.evt.start_prefix)g=this.evt.start_prefix+" "+
a;var j=this.measure_text(g,"timeline-event timeline-event-evt timeline-evt-start"),i=Math.floor(this.h_years-j.width);i-=12;var k=this.h;j=k-i;var l=this,m=function(){l.evt.start_link&&window.open(l.evt.start_link,"_timeline")};this.svg.append("text").text(g).attr("x",f+1.5).attr("y",j).attr("transform",function(){return"rotate("+[-90,f,k-i-3].join(",")+")"}).style("text-anchor","center").on("click",m).attr("class","timeline-event timeline-event-evt timeline-evt-start")}if(c&&c!=a&&c>this.min&&d){g=
c;if(this.evt.end_prefix)g=this.evt.end_prefix+" "+c;j=this.measure_text(g,"timeline-event timeline-event-evt timeline-evt-start");i=Math.floor(this.h_years-j.width);i-=9;k=this.h;j=k-i;f=this.scale(b);l=this;m=function(){l.evt.end_link&&window.open(l.evt.end_link,"_timeline")};this.svg.append("text").text(g).attr("x",f-1.5).attr("y",j).attr("transform",function(){return"rotate("+[-90,f,k-i-3].join(",")+")"}).on("click",m).style("text-anchor","center").attr("class","timeline-event timeline-event-year-ending timeline-event-evt timeline-event-evt-end")}if(this.evt.echo&&
this.evt.echo!=a&&h){g=this.evt.echo;if(this.evt.echo_prefix)g=this.evt.echo_prefix+" "+g;j=this.measure_text(g,"timeline-event timeline-event-evt timeline-evt-start");i=Math.floor(this.h_years-j.width);i-=9;k=this.h;j=k-i;f=this.scale(this.evt.echo);l=this;m=function(){l.evt.echo_link&&window.open(l.evt.echo_link,"_timeline")};this.svg.append("text").text(g).attr("x",f-1.5).attr("y",j).attr("transform",function(){return"rotate("+[-90,f,k-i-3].join(",")+")"}).on("click",m).style("text-anchor","center").attr("class",
"timeline-event timeline-event-evt timeline-evt-start")}if(this.draw_evt_span()){this.draw_span_line(e,b);this.draw_span_block(e,b)}else a&&this.draw_arrow(e,"youarehere");this.evt.echo&&this.draw_arrow(this.evt.echo,"echo","echo")}};
timeline.prototype.draw_arrow=function(a,c,e){var b=["youarehere"];a<this.min&&b.push("youarehere-before");a>this.max&&b.push("youarehere-after");b=b.join(" ");if(e)b+=" "+e;a=this.scale(a);e=this.h-(this.h_years+this.h_events);var f=this.h-(this.h_years+6),d=this.h-(this.h_years+4);this.svg.append("line").attr("id",c+"-shaft").attr("x1",a).attr("x2",a).attr("y1",e).attr("y2",f).attr("class",b);a=["M"+(a-6)+","+(d-6),"L"+a+","+d,"L"+(a+6)+","+(d-6),"Z"];this.svg.append("path").attr("id",c+"-head").attr("d",
a.join(" ")).attr("class",b)};timeline.prototype.remove_arrow=function(a){$("#"+a+"-head").remove();$("#"+a+"-shaft").remove()};timeline.prototype.draw_event_span=function(a,c,e){e="span-"+a+"-"+c+"-rect";a=this.scale(a);c=this.scale(c)-a;this.svg.append("rect").attr("id",e).attr("x",a).attr("y",this.h-(this.h_years+this.h_events)).attr("height",this.h_events).attr("width",c).attr("class","timeline-span-rect")};
timeline.prototype.draw_span_line=function(a,c){var e=this.scale(a),b=this.scale(c);this.svg.append("line").attr("id","thing").attr("x1",e).attr("x2",b).attr("y1",this.h-this.h_years+1.5).attr("y2",this.h-this.h_years+1.5).attr("class","timeline-span-line")};
timeline.prototype.draw_span_block=function(a,c,e){e||(e="span-"+a+"-"+c+"-block");a=this.scale(a);c=this.scale(c)-a;this.svg.append("rect").attr("id",e).attr("x",a).attr("y",this.h-(this.h_years+this.h_events)).attr("height",this.h_events).attr("width",c).attr("class","timeline-item")};timeline.prototype.does_overlap=function(a,c,e,b){if(c>e&&c<b)return 1;if(a>e||c>b)return 1;if(a<e&&c>b)return 1;if(a<e&&c>b)return 1;return 0};
timeline.prototype.is_between=function(a,c,e,b){if(b){a=this.scale(a)-b;c=this.scale(c)+b;e=this.scale(e)}return e>=a&&e<=c?1:0};
timeline.prototype.draw_evt_span=function(){var a=this.evt.start,c=this.evt.end,e=a,b=c;if(e<this.min)e=this.min-this.padding/2;if(c==0)b=(new Date).getYear()+1900;else if(b>this.max)b=this.max+this.padding/2;var f=0;if(a&&e!=b&&b)f=1;if(f&&a<this.min&&c<this.min)f=0;if(f&&this.is_between(this.before,this.min,a)&&this.is_between(this.before,this.min,c))f=0;if(f&&a<this.before&&c<this.before)f=0;if(f&&this.is_between(this.max,this.after,a)&&this.is_between(this.max,this.after,c))f=0;if(f&&a>this.after&&
c>this.after)f=0;return f};timeline.prototype.measure_text=function(a,c){if(!a||a.length===0)return{height:0,width:0};var e=this.svg.append("text").attr({x:-1000,y:-1000}).attr("class",c).text(a+"-"),b=e.node().getBBox();e.remove();return{height:b.height,width:b.width}};
